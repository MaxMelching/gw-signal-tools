# Inspired by https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/lib/gitlab/ci/templates/Python.gitlab-ci.yml

image: python:3.11.5  # TODO: maybe pull some igwn container? Should have all required things installed, for example gsl

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

before_script:  # Enabling virtual environment is recommended
  # - apt-get update && apt-get install libgsl-dev  # For surrogate model -> not sure if still required (gwsurrogate not needed, but we still want to call surrogate)
  - python --version ; pip --version  # For debugging
  - pip install virtualenv
  - virtualenv venv
  - source venv/bin/activate
# Also possible: use extends. If venv not needed for every script, for example


stages:
  - install
  - test
  - docs
  - deploy


# Test installation of repo
installation:
  stage: install
  script:
    - pip install '.[dev, jupyter]'
    - python -m setuptools_scm  # Print package version for debugging
  artifacts:
    paths:
      - build/*
  rules:
    - if: $CI_COMMIT_TAG
      when: never  # So that it is not executed when tags are pushed (they only point to commits, avoid duplicate tests)
    - if: $CI_COMMIT_BRANCH
      # when: manual  # Also possible for certain tests


# Verify code is running correctly
testing:
  stage: test
  # dependencies:
  #   - installation
  needs:
    - job: installation
      artifacts: true
  script:
    - pip install --find-links=PIP_CACHE_DIR .[dev]
    - python -m setuptools_scm  # Print package version for debugging
    - coverage run -m pytest  # --pyargs gw_signal_tools  # In case location is changed in the future
    # TODO: add -v at the end? Shows names of test that fail/pass during running
    - coverage report
    - coverage html
    # - mv htmlcov/ public/  # Huh, cannot acces this because no GitLab pages??
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'  # From https://gitlab.aei.uni-hannover.de/help/ci/testing/code_coverage.md#view-code-coverage-results-in-the-mr
  rules:
    - if: $CI_COMMIT_TAG
      when: never  # So that it is not executed when tags are pushed (they only point to commits, avoid duplicate tests)
    - if: $CI_COMMIT_BRANCH
      # when: manual  # Also possible for certain tests
  artifacts:
    paths:
      - htmlcov/*  # Maybe move them to public folder? So that they can be viewed
      # - public
